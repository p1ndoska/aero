# Описание автоматического тестирования API

Автоматическое тестирование API является критически важным этапом разработки, обеспечивающим стабильность работы системы при внесении изменений. В представленном фрагменте кода используется библиотека **Supertest** для тестирования HTTP-запросов к API, а также **Jest** в качестве тестового фреймворка для backend-компонентов и **Vitest** для frontend-компонентов.

## Архитектура тестирования

Система автоматического тестирования охватывает три основных функциональных области:

### 1. Тестирование авторизации пользователей

Тесты авторизации (`auth.test.js`) проверяют корректность работы механизма аутентификации через конечную точку `POST /api/login`. Тестовый набор включает:

- **Валидацию входных данных**: проверка обязательных полей (email, password) и возврат соответствующих HTTP-статусов (400 Bad Request) при их отсутствии
- **Обработку несуществующих пользователей**: проверка возврата ошибки 400 при попытке входа с неверными учетными данными
- **Верификацию паролей**: тестирование механизма сравнения хешированных паролей с использованием библиотеки bcrypt
- **Успешную авторизацию**: проверка генерации JWT-токенов, обновления времени последнего входа и возврата корректных данных пользователя
- **Обработку требований смены пароля**: тестирование логики принудительной смены пароля при первом входе или истечении срока действия

Тесты используют мокирование Prisma Client для изоляции тестового окружения от реальной базы данных, что обеспечивает быстрое выполнение и независимость тестов.

### 2. Тестирование управления подкатегориями услуг

Тесты управления подкатегориями услуг (`servicesCategory.test.js`) проверяют функциональность создания новых подкатегорий через конечную точку `POST /api/services-categories`. Тестовый набор включает:

- **Создание подкатегории с полными данными**: проверка успешного создания подкатегории с многоязычными полями (name, nameEn, nameBe, description, descriptionEn, descriptionBe) и автоматического создания связанной страницы контента
- **Валидацию уникальности pageType**: проверка предотвращения создания дублирующихся подкатегорий с одинаковым pageType и возврат ошибки 400
- **Использование значений по умолчанию**: тестирование применения дефолтных значений для опциональных полей (isActive: true, sortOrder: 0)
- **Обработку ошибок при создании связанных ресурсов**: проверка устойчивости системы при ошибках создания страницы контента - основная категория должна быть создана даже при сбое вторичных операций
- **Обработку внутренних ошибок сервера**: тестирование корректной обработки исключений базы данных и возврата статуса 500 с соответствующим сообщением об ошибке

Тесты демонстрируют проверку как авторизованного доступа (через middleware `authenticationToken` и `checkRole`), так и обработку различных сценариев ошибок.

### 3. Тестирование генерации капчи

Тесты генерации капчи охватывают как backend (`captcha.test.js`), так и frontend (`captcha.test.ts`) компоненты системы:

- **Валидацию длины генерируемой строки**: проверка генерации строки длиной 7 символов
- **Уникальность значений**: тестирование генерации различных значений при каждом вызове функции
- **Валидацию допустимых символов**: проверка использования только букв латинского алфавита (заглавных и строчных) и цифр
- **Проверку формата**: валидация соответствия регулярному выражению `^[A-Za-z0-9]{7}$`
- **Статистическую проверку уникальности**: тестирование генерации уникальных значений при множественных вызовах (проверка на коллизии)

## Технические особенности реализации

### Изоляция тестового окружения

Все тесты используют мокирование внешних зависимостей:
- **Prisma Client**: полностью замокан для изоляции от базы данных
- **bcrypt**: методы сравнения паролей замоканы для контролируемого тестирования
- **jsonwebtoken**: генерация токенов замокана для предсказуемых результатов
- **Console методы**: заглушены для чистого вывода тестов

### Структура тестов

Каждый тестовый файл следует единой структуре:
- `beforeEach`: настройка тестового окружения, создание Express-приложения, инициализация моков
- `afterEach`: очистка моков и восстановление оригинальных методов
- Группировка тестов по функциональным блокам с использованием `describe`
- Использование понятных имен тестов на русском языке для лучшей читаемости

### Покрытие тестами

Текущий набор тестов обеспечивает:
- **18 тестовых случаев** для backend-компонентов
- **7 тестовых случаев** для frontend-компонентов
- Покрытие критических путей выполнения кода
- Тестирование как успешных сценариев, так и обработки ошибок

## Преимущества автоматического тестирования

Внедрение автоматического тестирования обеспечивает:

1. **Раннее обнаружение ошибок**: проблемы выявляются на этапе разработки, до развертывания в production
2. **Регрессионное тестирование**: гарантия стабильности функциональности при внесении изменений
3. **Документирование поведения API**: тесты служат живой документацией ожидаемого поведения системы
4. **Уверенность при рефакторинге**: возможность безопасной модификации кода с гарантией сохранения функциональности
5. **Независимость от инфраструктуры**: использование моков позволяет запускать тесты без реальной базы данных

## Заключение

Представленная система автоматического тестирования обеспечивает надежную проверку критически важных компонентов API, включая механизмы авторизации, управления данными и генерации защитных кодов. Использование современных инструментов тестирования (Jest, Supertest, Vitest) в сочетании с правильной изоляцией тестового окружения позволяет поддерживать высокое качество кода и стабильность работы системы.



