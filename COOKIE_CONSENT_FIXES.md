# Исправления системы управления куки

## Проблема

Ранее настройки куки, которые выбирали пользователи, **НЕ РАБОТАЛИ**. Система только сохраняла предпочтения в localStorage, но не использовала их для управления функциональностью сайта.

## Что было исправлено

### 1. Создана утилита для работы с куки (`frontend/src/utils/cookieConsent.ts`)

- `getCookieConsent()` - получение настроек куки из localStorage
- `canUseAnalytics()` - проверка разрешения на аналитику
- `canUseMarketing()` - проверка разрешения на маркетинг
- `canUseFunctional()` - проверка разрешения на функциональные куки
- `withConsent()` - условное выполнение кода в зависимости от согласия
- `loadAnalyticsScript()` - загрузка аналитических скриптов с проверкой согласия
- `loadMarketingScript()` - загрузка маркетинговых скриптов с проверкой согласия

### 2. Обновлен LanguageContext

- Теперь сохранение языка в localStorage происходит только при разрешении функциональных куки
- При отключении функциональных куки язык не сохраняется между сессиями

### 3. Обновлен AccessibilityContext

- Настройки доступности сохраняются в localStorage только при разрешении функциональных куки
- При отключении функциональных куки настройки доступности не сохраняются

### 4. Создан демонстрационный компонент AnalyticsDemo

- Показывает текущий статус разрешений для аналитики и маркетинга
- Демонстрирует загрузку скриптов только при согласии пользователя
- Включает кнопку для тестирования отправки аналитических событий

## Как теперь работает система

### Необходимые куки (всегда включены)
- Аутентификация и безопасность
- Базовые функции сайта

### Функциональные куки
- Сохранение языка интерфейса
- Сохранение настроек доступности
- Другие пользовательские предпочтения

### Аналитические куки
- Загрузка Google Analytics
- Отслеживание взаимодействий пользователей
- Сбор анонимной статистики

### Маркетинговые куки
- Загрузка Facebook Pixel
- Ретаргетинг
- Измерение эффективности рекламы

## Использование

### Проверка разрешений

```typescript
import { canUseAnalytics, canUseMarketing, canUseFunctional } from '../utils/cookieConsent';

// Проверка перед загрузкой аналитики
if (canUseAnalytics()) {
  // Загружаем аналитические скрипты
}

// Проверка перед сохранением настроек
if (canUseFunctional()) {
  localStorage.setItem('user-preferences', JSON.stringify(preferences));
}
```

### Условное выполнение кода

```typescript
import { withConsent } from '../utils/cookieConsent';

// Выполнить код только при согласии на аналитику
withConsent('analytics', () => {
  // Отправить событие в Google Analytics
  gtag('event', 'page_view');
});
```

### Загрузка скриптов

```typescript
import { loadAnalyticsScript, loadMarketingScript } from '../utils/cookieConsent';

// Загрузка аналитики
loadAnalyticsScript('https://www.googletagmanager.com/gtag/js?id=GA_ID', 'google-analytics');

// Загрузка маркетинговых скриптов
loadMarketingScript('https://connect.facebook.net/en_US/fbevents.js', 'facebook-pixel');
```

## Тестирование

1. Откройте страницу политики куки (`/cookie-policy`)
2. Нажмите "Настроить" в баннере согласия на куки
3. Измените настройки и сохраните
4. Перейдите на страницу политики куки, чтобы увидеть демонстрацию
5. Проверьте консоль браузера для логов работы с куки

## Соответствие GDPR

Теперь система полностью соответствует требованиям GDPR:
- ✅ Пользователи могут выбирать категории куки
- ✅ Настройки сохраняются и соблюдаются
- ✅ Функциональность зависит от согласия пользователя
- ✅ Возможность изменить настройки в любое время


